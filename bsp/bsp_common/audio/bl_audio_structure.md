# bl音频协议框架

## 核心音频播放组件

如下图所示

[![c1Q8qe.jpg](https://z3.ax1x.com/2021/04/06/c1Q8qe.jpg)](https://imgtu.com/i/c1Q8qe)


整体框架分为两个部分，一个部分是由核心组件提供的双缓存结构，另一个部分是用户的实际使用代码。

**核心组件需要两个构件**

1 双缓存，用户需要在自己的应用中开辟两块长度相同的内存块，将其指针传入核心组件。

2 dma组件，用户需要将配置好了的 dma device 指针传入核心组件，此dma的作用是将设备的数据通过P->M写回Buffer 或者 将数据通过M->P写入Device。搬运的request需要在device的配置参数中给定。



**核心组件后的运行逻辑**

当用户打开音频构架的核心组件代码后
组件会首先初始化Buffer1和Buffer2的内容，初始化为0，并且立即打开DMA搬运。
当DMA搬运结束，会触发Buffer_Ready中断回调。

在录音的应用下

打开核心组件后，DMA会根据Device的DMA Request，把录音数据搬运到Buffer1和Buffer2，用户需要做的是在Buffer_Ready中断回调发生后，将对应Buffer取出来，保存、或者通过下文提到的协议发送。

在播放音频的应用下

打开核心组件后，DMA会立即播放Buffer1和Buffer2的数据，但是因为最开始的时候已经初始化Buffer数据为0，所以不会有任何声音播放。用户需要在Buffer_Ready中断回调发生后，以合适的方式，将需要播放的PCM音频数据更新到Buffer中（此过程必须在下一个Buffer消耗完成之前，否则会产生问题），如果在buffer2的数据消耗结束之前还没能完成buffer1的数据更新，那么需要考虑如何加快数据更新速度，或者增加Buffer的size以提供更多操作时间。


## 2 通讯协议约定

当用户代码部分需要与外界进行通讯时，需要统一规范一个交互的协议，这样不同的音频应用可以兼容相同的audio_cube。

1 传输音频文件流（目前仅支持wav格式播放）
2 每次传输的字节数，使用规范的约定字节数
3 是否支持校验
4 播放/暂停 停止 音量调整的固定协议