

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>1. API 分层模型 &mdash; BL_MCU_SDK 开发指南 0.1 文档</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="1. 流水灯示例" href="blink_demo_introduce.html" />
    <link rel="prev" title="5. 硬件连接" href="connecting_hardware.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> BL_MCU_SDK 开发指南
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">快速开发指南</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="get_started.html">1. 开发前的准备</a></li>
<li class="toctree-l1"><a class="reference internal" href="Windows_quick_start_cdk.html">2. Windows 下使用 CDK (类 MDK Keil)开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="Windows_quick_start_eclipse.html">3. Windows 下使用 Eclipse 开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="Linux_quick_start_ubuntu.html">4. Linux 环境开发指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="connecting_hardware.html">5. 硬件连接</a></li>
</ul>
<p class="caption"><span class="caption-text">API 手册</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. API 分层模型</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id1">1.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">1.2. 设备驱动管理层实现</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id3">1.3. 设备驱动管理层标准接口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#device-register">1.3.1. <strong>device_register</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-unregister">1.3.2. <strong>device_unregister</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-find">1.3.3. <strong>device_find</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-open">1.3.4. <strong>device_open</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-close">1.3.5. <strong>device_close</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-control">1.3.6. <strong>device_control</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-write">1.3.7. <strong>device_write</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-read">1.3.8. <strong>device_read</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#device-set-callback">1.3.9. <strong>device_set_callback</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id4">1.4. 外设驱动适配层实现</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#id5">2. 时钟树</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id6">2.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id7">2.2. 时钟频率获取接口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-clock-get">2.2.1. <strong>system_clock_get</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#peripheral-clock-get">2.2.2. <strong>peripheral_clock_get</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gpio">3. GPIO 设备</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id8">3.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id9">3.2. GPIO 设备接口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#gpio-set-mode">3.2.1. <strong>gpio_set_mode</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpio-write">3.2.2. <strong>gpio_write</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpio-toggle">3.2.3. <strong>gpio_toggle</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpio-read">3.2.4. <strong>gpio_read</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpio-attach-irq">3.2.5. <strong>gpio_attach_irq</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#gpio-irq-enable">3.2.6. <strong>gpio_irq_enable</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#uart">4. UART 设备</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id10">4.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id11">4.2. UART 设备结构体定义</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id12">4.3. UART 设备参数配置表</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id13">4.4. UART 设备接口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#uart-register">4.4.1. <strong>uart_register</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">4.4.2. <strong>device_open</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">4.4.3. <strong>device_close</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id16">4.4.4. <strong>device_control</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">4.4.5. <strong>device_write</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">4.4.6. <strong>device_read</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id19">4.4.7. <strong>device_set_callback</strong></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pwm">5. PWM设备</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#id20">5.1. 简介</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id21">5.2. PWM设备接口</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pwm-register">5.2.1. <strong>pwm_register</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id22">5.2.2. <strong>device_open</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id23">5.2.3. <strong>device_close</strong></a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">5.2.4. <strong>device_control</strong></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">示例代码</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="blink_demo_introduce.html">1. 流水灯示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="breath_pwm_demo_introduce.html">2. 呼吸灯示例</a></li>
<li class="toctree-l1"><a class="reference internal" href="uart_loopback_demo_introduce.html">3. 串口自收发示例</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">BL_MCU_SDK 开发指南</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">1. </span>API 分层模型</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/api_guide.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="api">
<h1><span class="section-number">1. </span>API 分层模型<a class="headerlink" href="#api" title="永久链接至标题">¶</a></h1>
<div class="section" id="id1">
<h2><span class="section-number">1.1. </span>简介<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>为了不影响用户应用层代码因为芯片驱动的不同而频繁修改，<strong>bl_mcu_sdk</strong> 的外设 API 采用了 HAL 层的思想，屏蔽了底层硬件的实现。而 HAL 层又分为两大类：</p>
<ul class="simple">
<li><p>设备驱动管理层：提供一套标准的接口，具体实现由外设驱动适配层实现。</p></li>
<li><p>外设驱动适配层：实现设备驱动管理层的标准接口，并且拓展自己的独特的接口。</p></li>
</ul>
<p>整体的代码分层框架如图所示：</p>
<div class="figure align-default" id="id25">
<img alt="" src="_images/api1.png" />
<p class="caption"><span class="caption-text">code structure</span><a class="headerlink" href="#id25" title="永久链接至图片">¶</a></p>
</div>
<ul class="simple">
<li><p>应用层是用户自己编写的代码，接口则是调用 hal 层的接口。</p></li>
<li><p>HAL 层提供给应用层接口，底层调用 std 层，不同的芯片调用不同的 std 层。</p></li>
<li><p>STD 层则是对硬件寄存器进行简单封装，由外设驱动适配层进行调用。</p></li>
</ul>
</div>
<div class="section" id="id2">
<h2><span class="section-number">1.2. </span>设备驱动管理层实现<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>设备驱动管理层的实现采用了面向对象的思想，首先我们将外设看成是一个设备或者是文件，秉承 <strong>一切皆文件</strong> 的理念，而文件又都具有标准的调用接口：<code class="docutils literal notranslate"><span class="pre">open</span></code>、<code class="docutils literal notranslate"><span class="pre">close</span></code>、<code class="docutils literal notranslate"><span class="pre">ctrl</span></code>、<code class="docutils literal notranslate"><span class="pre">write</span></code>、<code class="docutils literal notranslate"><span class="pre">read</span></code>、<code class="docutils literal notranslate"><span class="pre">callback</span></code>，不同文件类别不同（比如串口设备、ADC设备、SPI设备），并且打开的方式也不同（比如轮询、中断、DMA），由此，我们可以构建出一个对象的基类（父类）。</p>
<p><strong>基类</strong></p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">device</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">NAME_MAX</span><span class="p">];</span>            <span class="cm">/*name of device */</span>
    <span class="n">dlist_t</span> <span class="n">list</span><span class="p">;</span>                   <span class="cm">/*list node of device */</span>
    <span class="k">enum</span> <span class="n">device_status_type</span> <span class="n">status</span><span class="p">;</span> <span class="cm">/*status of device */</span>
    <span class="k">enum</span> <span class="n">device_class_type</span> <span class="n">type</span><span class="p">;</span>    <span class="cm">/*type of device */</span>
    <span class="kt">uint16_t</span> <span class="n">oflag</span><span class="p">;</span>                 <span class="cm">/*oflag of device */</span>

    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">oflag</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">close</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">control</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pos</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">event</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p><strong>基类成员：name</strong></p>
<p>给设备取名，后面会使用 <code class="docutils literal notranslate"><span class="pre">device_find</span></code> 找到这个设备。</p>
<p><strong>基类成员：type</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">type</span></code> 记录当前设备的类别，可以选择的 <code class="docutils literal notranslate"><span class="pre">type</span></code> 类型如下。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">device_class_type</span>
<span class="p">{</span>
    <span class="n">DEVICE_CLASS_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_GPIO</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_UART</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_SPI</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_I2C</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_ADC</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_DMA</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_TIMER</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_PWM</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_SDIO</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_USB</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_I2S</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_CAMERA</span><span class="p">,</span>
    <span class="n">DEVICE_CLASS_SEC_HASH</span><span class="p">,</span>
<span class="p">}</span> <span class="p">;</span>
</pre></div>
</div>
<p><strong>基类成员：status</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">status</span></code> 用来记录当前设备的状态，当前提供 4 种状态。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">device_status_type</span>
<span class="p">{</span>
    <span class="n">DEVICE_UNREGISTER</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">DEVICE_REGISTERED</span><span class="p">,</span>
    <span class="n">DEVICE_OPENED</span><span class="p">,</span>
    <span class="n">DEVICE_CLOSED</span>
<span class="p">}</span> <span class="p">;</span>
</pre></div>
</div>
<p><strong>基类成员：oflag</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">oflag</span></code> 记录 注册时填入的 flag 信息以及使用 <code class="docutils literal notranslate"><span class="pre">device_open</span></code> 时填入的 <code class="docutils literal notranslate"><span class="pre">oflag</span></code> 信息。</p>
<p><strong>基类成员：list</strong></p>
<p>设备的增加和删除使用双向链表进行存储，节省内存。</p>
<p><strong>基类成员：标准的函数指针</strong></p>
<p>为不同的外设提供了标准的函数接口，当外设实现此类接口并赋值给该成员，便能达到重写的功能。</p>
</div>
<div class="section" id="id3">
<h2><span class="section-number">1.3. </span>设备驱动管理层标准接口<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<div class="section" id="device-register">
<h3><span class="section-number">1.3.1. </span><strong>device_register</strong><a class="headerlink" href="#device-register" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_register</span></code> 用于设备的注册，将设备信息注册到链表当中。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_register</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">flag</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄。</p></li>
<li><p>name 设备名称。</p></li>
<li><p>flag 设备的读写属性</p></li>
<li><p>return 返回错误码，0 表示注册成功，其他表示错误。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">flag</span></code> 可以写入以下参数，表示：<strong>只读</strong>、<strong>只写</strong>、<strong>可读可写</strong>。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEVICE_OFLAG_RDONLY 0x1000 </span><span class="cm">/* 以只读方式打开设备 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_WRONLY 0x2000 </span><span class="cm">/* 以只写方式打开设备 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_RDWR   0x3000 </span><span class="cm">/* 以读写方式打开设备 */</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="device-unregister">
<h3><span class="section-number">1.3.2. </span><strong>device_unregister</strong><a class="headerlink" href="#device-unregister" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_unregister</span></code> 用于设备的删除，将设备信息从链表中删除。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_unregister</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>name 要删除的设备名称</p></li>
<li><p>return 错误码，0 表示删除，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="device-find">
<h3><span class="section-number">1.3.3. </span><strong>device_find</strong><a class="headerlink" href="#device-find" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_find</span></code> 用于根据 <code class="docutils literal notranslate"><span class="pre">name</span></code> 从链表中寻找设备，并返回设备句柄的首地址。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">device_find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>name 要查找的设备名称</p></li>
<li><p>return 错误码，不为 0 表示找到的设备句柄，NULL 表示未找到该设备。</p></li>
</ul>
</div>
<div class="section" id="device-open">
<h3><span class="section-number">1.3.4. </span><strong>device_open</strong><a class="headerlink" href="#device-open" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_open</span></code> 用于设备的打开，<code class="docutils literal notranslate"><span class="pre">oflag</span></code> 表示以何种方式打开，目前提供 6 种打开方式。底层调用 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 句柄中的 <code class="docutils literal notranslate"><span class="pre">open</span></code> 成员。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">oflag</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>oflag 设备的打开方式</p></li>
<li><p>return 错误码，0 表示打开成功，其他表示错误</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">oflag</span></code> 可以写入以下参数：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEVICE_OFLAG_STREAM_TX  0x001 </span><span class="cm">/* 设备以轮训发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_STREAM_RX  0x002 </span><span class="cm">/* 设备以轮训接收模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_INT_TX     0x004 </span><span class="cm">/* 设备以中断发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_INT_RX     0x008 </span><span class="cm">/* 设备以中断接收模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_DMA_TX     0x010 </span><span class="cm">/* 设备以 DMA 发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_DMA_RX     0x020 </span><span class="cm">/* 设备以 DMA 接收模式打开 */</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="device-close">
<h3><span class="section-number">1.3.5. </span><strong>device_close</strong><a class="headerlink" href="#device-close" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_close</span></code> 用于设备的关闭。底层调用 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 句柄中的 <code class="docutils literal notranslate"><span class="pre">close</span></code> 成员。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>return 错误码，0 表示关闭成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="device-control">
<h3><span class="section-number">1.3.6. </span><strong>device_control</strong><a class="headerlink" href="#device-control" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_control</span></code> 用于根据命令对设备进行控制和参数的修改。底层调用 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 句柄中的 <code class="docutils literal notranslate"><span class="pre">control</span></code> 成员。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_control</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>cmd 设备控制命令</p></li>
<li><p>args 控制参数</p></li>
<li><p>return 不同的控制命令返回的意义不同。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">cmd</span></code> 提供了以下标准命令，除此之外，不同外设还具有自己的命令</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEVICE_CTRL_SET_INT             0x01    </span><span class="cm">/* set interrupt */</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_CLR_INT             0x02    </span><span class="cm">/* clear interrupt */</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_GET_INT             0x03    </span><span class="cm">/* get interrupt status*/</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_RESUME              0x04    </span><span class="cm">/* resume device */</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_SUSPEND             0x05    </span><span class="cm">/* suspend device */</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_CONFIG              0x06    </span><span class="cm">/* config device */</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_GET_CONFIG          0x07    </span><span class="cm">/* get device configuration */</span><span class="cp"></span>
<span class="cp">#define DEVICE_CTRL_ATTACH_TX_DMA       0x08</span>
<span class="cp">#define DEVICE_CTRL_ATTACH_RX_DMA       0x09</span>
<span class="cp">#define DEVICE_CTRL_TX_DMA_SUSPEND      0x0a</span>
<span class="cp">#define DEVICE_CTRL_RX_DMA_SUSPEND      0x0b</span>
<span class="cp">#define DEVICE_CTRL_TX_DMA_RESUME       0x0c</span>
<span class="cp">#define DEVICE_CTRL_RX_DMA_RESUME       0x0d</span>
<span class="cp">#define DEVICE_CTRL_RESVD1              0x0E</span>
<span class="cp">#define DEVICE_CTRL_RESVD2              0x0F</span>
</pre></div>
</div>
</div>
<div class="section" id="device-write">
<h3><span class="section-number">1.3.7. </span><strong>device_write</strong><a class="headerlink" href="#device-write" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_write</span></code> 用于数据的发送，发送方式根据打开方式可以是轮询、中断、dma。底层调用 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 句柄中的 <code class="docutils literal notranslate"><span class="pre">write</span></code> 成员。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_write</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pos</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>pos 不同的设备 pos 的意义不同</p></li>
<li><p>buffer 要写入的 buffer 缓冲区</p></li>
<li><p>size 要写入的长度</p></li>
<li><p>return 错误码，0 表示写入成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="device-read">
<h3><span class="section-number">1.3.8. </span><strong>device_read</strong><a class="headerlink" href="#device-read" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_read</span></code> 用于数据的接收，接收方式根据打开方式可以是轮询、中断、dma。底层调用 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 句柄中的 <code class="docutils literal notranslate"><span class="pre">read</span></code> 成员。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_read</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>pos 不同的设备 pos 的意义不同</p></li>
<li><p>buffer 要读入的 buffer 缓冲区</p></li>
<li><p>size 要读入的长度</p></li>
<li><p>return 错误码，0 表示读入成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="device-set-callback">
<h3><span class="section-number">1.3.9. </span><strong>device_set_callback</strong><a class="headerlink" href="#device-set-callback" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_set_callback</span></code> 用于中断回调函数的注册。底层调用 <code class="docutils literal notranslate"><span class="pre">dev</span></code> 句柄中的 <code class="docutils literal notranslate"><span class="pre">callback</span></code> 成员。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_set_callback</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">event</span><span class="p">));</span>
</pre></div>
</div>
<ul>
<li><p>dev 设备句柄</p></li>
<li><p>callback 要注册的中断回调函数</p>
<blockquote>
<div><ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>args 不同外设意义不同</p></li>
<li><p>size 传输长度</p></li>
<li><p>event 中断事件类型</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
</div>
<div class="section" id="id4">
<h2><span class="section-number">1.4. </span>外设驱动适配层实现<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p><strong>子类继承父类</strong></p>
<p>不同的外设首成员为 <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span></code> ，这就相当于父类的继承，从而可以使用子类来访问父类成员，当使用子类修改父类成员时，便拥有了子类自己的功能。实现原理是不同结构体的首地址是该结构体中首个成员的地址。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">xxx_device</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">device</span> <span class="n">parent</span><span class="p">;</span>

<span class="p">}</span> <span class="n">xxx_device_t</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>重写标准接口</strong></p>
<p>每个外设都有一个 <code class="docutils literal notranslate"><span class="pre">xxx_register</span></code> 函数，用来重写标准接口。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">xxx_open</span><span class="p">;</span>
<span class="n">dev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">xxx_close</span><span class="p">;</span>
<span class="n">dev</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">xxx_control</span><span class="p">;</span>
<span class="n">dev</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="n">xxx_write</span><span class="p">;</span>
<span class="n">dev</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">xxx_read</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id5">
<h1><span class="section-number">2. </span>时钟树<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h1>
<div class="section" id="id6">
<h2><span class="section-number">2.1. </span>简介<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>博流系列芯片拥有丰富的时钟源选择，为方便用户配置，提供了时钟树配置表，不需要用户手动调用时钟设置接口，用户只需要关心最终的系统时钟和外设时钟频率即可。时钟配置表位于 <code class="docutils literal notranslate"><span class="pre">bsp/board/xxx_board</span></code> 目录下 <code class="docutils literal notranslate"><span class="pre">xxx_clock_config.h</span></code> 文件。</p>
</div>
<div class="section" id="id7">
<h2><span class="section-number">2.2. </span>时钟频率获取接口<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<div class="section" id="system-clock-get">
<h3><span class="section-number">2.2.1. </span><strong>system_clock_get</strong><a class="headerlink" href="#system-clock-get" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">system_clock_get</span></code> 用来获取系统时钟频率。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span> <span class="nf">system_clock_get</span><span class="p">(</span><span class="k">enum</span> <span class="n">system_clock_type</span> <span class="n">type</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>type 获取的系统时钟频率类型</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">type</span></code> 提供以下几种类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">system_clock_type</span>
<span class="p">{</span>
    <span class="n">SYSTEM_CLOCK_ROOT_CLOCK</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">SYSTEM_CLOCK_FCLK</span><span class="p">,</span>
    <span class="n">SYSTEM_CLOCK_BCLK</span><span class="p">,</span>
    <span class="n">SYSTEM_CLOCK_XCLK</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="peripheral-clock-get">
<h3><span class="section-number">2.2.2. </span><strong>peripheral_clock_get</strong><a class="headerlink" href="#peripheral-clock-get" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">peripheral_clock_get</span></code> 用来获取外设时钟频率。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">uint32_t</span> <span class="nf">peripheral_clock_get</span><span class="p">(</span><span class="k">enum</span> <span class="n">peripheral_clock_type</span> <span class="n">type</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>type 获取的外设时钟频率类型</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">type</span></code> 提供以下几种类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">peripheral_clock_type</span>
<span class="p">{</span>
    <span class="n">PERIPHERAL_CLOCK_UART</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">PERIPHERAL_CLOCK_SPI</span><span class="p">,</span>
    <span class="n">PERIPHERAL_CLOCK_I2C</span><span class="p">,</span>
    <span class="n">PERIPHERAL_CLOCK_ADC</span><span class="p">,</span>
    <span class="n">PERIPHERAL_CLOCK_DAC</span><span class="p">,</span>
    <span class="n">PERIPHERAL_CLOCK_I2S</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="gpio">
<h1><span class="section-number">3. </span>GPIO 设备<a class="headerlink" href="#gpio" title="永久链接至标题">¶</a></h1>
<div class="section" id="id8">
<h2><span class="section-number">3.1. </span>简介<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<p>GPIO 全称 General Purpose Input Output（通用输入 / 输出），博流系列芯片的 GPIO 外设主要有以下功能。</p>
<ul class="simple">
<li><p>普通输入输出带上下拉</p></li>
<li><p>复用功能带上下拉</p></li>
<li><p>模拟功能</p></li>
<li><p>外部中断（上升沿、下降沿、高电平、低电平）</p></li>
<li><p>硬件消抖</p></li>
<li><p>驱动能力控制</p></li>
</ul>
<p>bl mcu sdk 的引脚配置方式分为两种。</p>
<ul class="simple">
<li><p>GPIO 复用功能通过专门的 <strong>pinmux table</strong> ，用户只需要修改 table 中的相关引脚的功能，程序会自动配置这些引脚。<strong>pinmux table</strong> 位于 <code class="docutils literal notranslate"><span class="pre">bsp/board/xxx_board</span></code> 目录下 <code class="docutils literal notranslate"><span class="pre">pinmux_config.h</span></code> 文件。</p></li>
<li><p>通过标准的 GPIO 设备接口配置引脚，缺点是只能配置普通的输入输出和中断功能，复用功能建议还是使用 table 进行配置。</p></li>
</ul>
</div>
<div class="section" id="id9">
<h2><span class="section-number">3.2. </span>GPIO 设备接口<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h2>
<div class="section" id="gpio-set-mode">
<h3><span class="section-number">3.2.1. </span><strong>gpio_set_mode</strong><a class="headerlink" href="#gpio-set-mode" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">gpio_set_mode</span></code> 用来配置 gpio 的模式。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">gpio_set_mode</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pin</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">mode</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>pin 要配置的引脚</p></li>
<li><p>mode 要配置的引脚功能</p></li>
</ul>
<p>mode 提供以下几种类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define GPIO_OUTPUT_MODE                        0</span>
<span class="cp">#define GPIO_OUTPUT_PP_MODE                     1</span>
<span class="cp">#define GPIO_OUTPUT_PD_MODE                     2</span>
<span class="cp">#define GPIO_INPUT_MODE                         3</span>
<span class="cp">#define GPIO_INPUT_PP_MODE                      4</span>
<span class="cp">#define GPIO_INPUT_PD_MODE                      5</span>
<span class="cp">#define GPIO_ASYNC_RISING_TRIGER_INT_MODE       6</span>
<span class="cp">#define GPIO_ASYNC_FALLING_TRIGER_INT_MODE      7</span>
<span class="cp">#define GPIO_ASYNC_HIGH_LEVEL_INT_MODE          8</span>
<span class="cp">#define GPIO_ASYNC_LOW_LEVEL_INT_MODE           9</span>
<span class="cp">#define GPIO_SYNC_RISING_TRIGER_INT_MODE        10</span>
<span class="cp">#define GPIO_SYNC_FALLING_TRIGER_INT_MODE       11</span>
<span class="cp">#define GPIO_SYNC_HIGH_LEVEL_INT_MODE           12</span>
<span class="cp">#define GPIO_SYNC_LOW_LEVEL_INT_MODE            13</span>
</pre></div>
</div>
</div>
<div class="section" id="gpio-write">
<h3><span class="section-number">3.2.2. </span><strong>gpio_write</strong><a class="headerlink" href="#gpio-write" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">gpio_write</span></code> 设置引脚电平</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">gpio_write</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pin</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">value</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>pin 要设置的引脚</p></li>
<li><p>value 要设置的电平</p></li>
</ul>
</div>
<div class="section" id="gpio-toggle">
<h3><span class="section-number">3.2.3. </span><strong>gpio_toggle</strong><a class="headerlink" href="#gpio-toggle" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">gpio_toggle</span></code> 翻转引脚电平</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">gpio_toggle</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pin</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>pin 要翻转的引脚</p></li>
</ul>
</div>
<div class="section" id="gpio-read">
<h3><span class="section-number">3.2.4. </span><strong>gpio_read</strong><a class="headerlink" href="#gpio-read" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">gpio_read</span></code> 读取引脚电平</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>  <span class="nf">gpio_read</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pin</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>pin 要读取电平的引脚</p></li>
<li><p>return 0 为低电平，1 为高电平</p></li>
</ul>
</div>
<div class="section" id="gpio-attach-irq">
<h3><span class="section-number">3.2.5. </span><strong>gpio_attach_irq</strong><a class="headerlink" href="#gpio-attach-irq" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">gpio_attach_irq</span></code> 为中断引脚附加中断回调函数</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">gpio_attach_irq</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pin</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">cbFun</span><span class="p">)(</span><span class="kt">void</span><span class="p">));</span>
</pre></div>
</div>
<ul class="simple">
<li><p>pin 要附加中断回调的引脚</p></li>
<li><p>cbFun 中断回调函数</p></li>
</ul>
</div>
<div class="section" id="gpio-irq-enable">
<h3><span class="section-number">3.2.6. </span><strong>gpio_irq_enable</strong><a class="headerlink" href="#gpio-irq-enable" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">gpio_irq_enable</span></code> 读取引脚电平</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">gpio_irq_enable</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">pin</span><span class="p">,</span><span class="kt">uint8_t</span> <span class="n">enabled</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>pin 要开启或者关闭中断的引脚</p></li>
<li><p>enabled 0 为关闭中断，1 为打开中断</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="uart">
<h1><span class="section-number">4. </span>UART 设备<a class="headerlink" href="#uart" title="永久链接至标题">¶</a></h1>
<div class="section" id="id10">
<h2><span class="section-number">4.1. </span>简介<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h2>
<p>UART 全称（Universal Asynchronous Receiver/Transmitter）通用异步收发传输器，博流系列芯片的 UART 外设自带可配深度 <strong>硬件fifo</strong> ，并且拥有 <strong>RTO（接收超时）中断</strong> ，在使用中断的时候，无需频繁进入中断，fifo 和 rto 的搭配能够使得 UART 的利用性更加高效，UART 设备具有以下功能。</p>
<ul class="simple">
<li><p>轮询收发模式</p></li>
<li><p>中断收发模式</p></li>
<li><p>dma 收发模式</p></li>
<li><p>自动波特率检测</p></li>
<li><p>硬件 fifo</p></li>
<li><p>特有的 rto 中断</p></li>
</ul>
</div>
<div class="section" id="id11">
<h2><span class="section-number">4.2. </span>UART 设备结构体定义<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h2>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">uart_device</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">device</span> <span class="n">parent</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">baudrate</span><span class="p">;</span>
    <span class="n">uart_databits_t</span> <span class="n">databits</span><span class="p">;</span>
    <span class="n">uart_stopbits_t</span> <span class="n">stopbits</span><span class="p">;</span>
    <span class="n">uart_parity_t</span> <span class="n">parity</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">fifo_threshold</span><span class="p">;</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">tx_dma</span><span class="p">;</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">rx_dma</span><span class="p">;</span>
<span class="p">}</span> <span class="n">uart_device_t</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>parent 继承父类属性</p></li>
<li><p>id 串口 id，0 表示串口 0，,1 表示串口 1，以此类推</p></li>
<li><p>baudrate 波特率</p></li>
<li><p>databits 数据位</p></li>
<li><p>stopbits 停止位</p></li>
<li><p>parity 校验位</p></li>
<li><p>fifo_threshold fifo 阈值,不同 mcu 最大值不同</p></li>
<li><p>tx_dma 附加的发送 dma 句柄</p></li>
<li><p>rx_dma 附加的接收 dma 句柄</p></li>
</ul>
<p>databits 提供以下类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
    <span class="n">UART_DATA_LEN_5</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="cm">/*!&lt; Data length is 5 bits */</span>
    <span class="n">UART_DATA_LEN_6</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="cm">/*!&lt; Data length is 6 bits */</span>
    <span class="n">UART_DATA_LEN_7</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="cm">/*!&lt; Data length is 7 bits */</span>
    <span class="n">UART_DATA_LEN_8</span> <span class="o">=</span> <span class="mi">3</span>   <span class="cm">/*!&lt; Data length is 8 bits */</span>
<span class="p">}</span> <span class="n">uart_databits_t</span><span class="p">;</span>
</pre></div>
</div>
<p>stopbits 提供以下类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
    <span class="n">UART_STOP_ONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="cm">/*!&lt; One stop bit */</span>
    <span class="n">UART_STOP_ONE_D_FIVE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="cm">/*!&lt; 1.5 stop bit */</span>
    <span class="n">UART_STOP_TWO</span> <span class="o">=</span> <span class="mi">1</span>   <span class="cm">/*!&lt; Two stop bits */</span>
<span class="p">}</span> <span class="n">uart_stopbits_t</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">parity</span></code> 提供以下类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">enum</span>
<span class="p">{</span>
    <span class="n">UART_PAR_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>  <span class="cm">/*!&lt; No parity */</span>
    <span class="n">UART_PAR_ODD</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="cm">/*!&lt; Parity bit is odd */</span>
    <span class="n">UART_PAR_EVEN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="cm">/*!&lt; Parity bit is even */</span>
<span class="p">}</span> <span class="n">uart_parity_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="id12">
<h2><span class="section-number">4.3. </span>UART 设备参数配置表<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h2>
<p>每一个 UART 设备都有一个参数配置，配置文件位于 <code class="docutils literal notranslate"><span class="pre">bsp/board/xxx_board</span></code> 目录下 <code class="docutils literal notranslate"><span class="pre">peripheral_config.h</span></code> 文件。当用户打开对应设备的宏，该设备的配置才生效。例如打开宏 <code class="docutils literal notranslate"><span class="pre">BSP_USING_UART0</span></code> ，UART0 设备就可以进行注册和使用了。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">uart_device_t</span> <span class="n">uartx_device</span><span class="p">[</span><span class="n">UART_MAX_INDEX</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cp">#ifdef BSP_USING_UART0</span>
        <span class="n">UART0_CONFIG</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_UART1</span>
        <span class="n">UART1_CONFIG</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#if defined(BSP_USING_UART0)</span>
<span class="cp">#ifndef UART0_CONFIG</span>
<span class="cp">#define UART0_CONFIG \</span>
<span class="cp">{   \</span>
<span class="cp"> .id = 0, \</span>
<span class="cp"> .baudrate = 2000000,\</span>
<span class="cp"> .databits = UART_DATA_LEN_8, \</span>
<span class="cp"> .stopbits = UART_STOP_ONE, \</span>
<span class="cp"> .parity = UART_PAR_NONE, \</span>
<span class="cp"> .fifo_threshold = 1, \</span>
<span class="cp">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
</pre></div>
</div>
</div>
<div class="section" id="id13">
<h2><span class="section-number">4.4. </span>UART 设备接口<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h2>
<p>UART 设备接口全部遵循标准设备驱动管理层提供的接口。</p>
<div class="section" id="uart-register">
<h3><span class="section-number">4.4.1. </span><strong>uart_register</strong><a class="headerlink" href="#uart-register" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">uart_register</span></code> 用来注册一个 UART 设备，在注册之前需要打开对应 UART 设备的宏定义,例如 <code class="docutils literal notranslate"><span class="pre">BSP_USING_UART0</span></code> 方可使用 UART0 设备。注册完成以后才可以使用其他接口，如果没有定义宏，则无法使用 UART 设备。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">uart_register</span><span class="p">(</span><span class="k">enum</span> <span class="n">uart_index_type</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">flag</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>index 要注册的设备索引</p></li>
<li><p>name 为注册的设备命名</p></li>
<li><p>flag 默认可读可写属性</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">index</span></code> 用来选择 UART 设备配置，一个 index 对应一个 UART 设备配置，比如 <code class="docutils literal notranslate"><span class="pre">UART0_INDEX</span></code> 对应 UART0 配置，<code class="docutils literal notranslate"><span class="pre">index</span></code> 有如下可选类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">uart_index_type</span>
<span class="p">{</span>
<span class="cp">#ifdef BSP_USING_UART0</span>
    <span class="n">UART0_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_UART1</span>
    <span class="n">UART1_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_UART2</span>
    <span class="n">UART2_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_UART3</span>
    <span class="n">UART3_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_UART4</span>
    <span class="n">UART4_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
    <span class="n">UART_MAX_INDEX</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="id14">
<h3><span class="section-number">4.4.2. </span><strong>device_open</strong><a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_open</span></code> 用于设备的打开，<code class="docutils literal notranslate"><span class="pre">oflag</span></code> 表示以何种方式打开。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">oflag</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>oflag 设备的打开方式</p></li>
<li><p>return 错误码，0 表示打开成功，其他表示错误</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">oflag</span></code> 可以写入以下参数：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEVICE_OFLAG_STREAM_TX  0x001 </span><span class="cm">/* 设备以轮训发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_STREAM_RX  0x002 </span><span class="cm">/* 设备以轮训接收模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_INT_TX     0x004 </span><span class="cm">/* 设备以中断发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_INT_RX     0x008 </span><span class="cm">/* 设备以中断接收模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_DMA_TX     0x010 </span><span class="cm">/* 设备以 DMA 发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_DMA_RX     0x020 </span><span class="cm">/* 设备以 DMA 接收模式打开 */</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="id15">
<h3><span class="section-number">4.4.3. </span><strong>device_close</strong><a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_close</span></code> 用于设备的关闭。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>return 错误码，0 表示关闭成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="id16">
<h3><span class="section-number">4.4.4. </span><strong>device_control</strong><a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_control</span></code> 用于根据命令对设备进行控制和参数的修改。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_control</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>cmd 设备控制命令</p></li>
<li><p>args 控制参数</p></li>
<li><p>return 不同的控制命令返回的意义不同。</p></li>
</ul>
<p>串口设备除了标准的控制命令，还具有自己特殊的控制命令。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEVICE_CTRL_UART_GET_TX_FIFO        0x10</span>
<span class="cp">#define DEVICE_CTRL_UART_GET_RX_FIFO        0x11</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">args</span></code> 根据不同的 <code class="docutils literal notranslate"><span class="pre">cmd</span></code> 传入不同，具体如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 51%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>cmd</p></th>
<th class="head"><p>args</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DEVICE_CTRL_SET_INT</p></td>
<td><p>uart_it_type</p></td>
</tr>
<tr class="row-odd"><td><p>DEVICE_CTRL_CLR_INT</p></td>
<td><p>uart_it_type</p></td>
</tr>
<tr class="row-even"><td><p>DEVICE_CTRL_CONFIG</p></td>
<td><p>uart_param_cfg_t</p></td>
</tr>
<tr class="row-odd"><td><p>DEVICE_CTRL_ATTACH_TX_DMA</p></td>
<td><p>dma句柄</p></td>
</tr>
<tr class="row-even"><td><p>DEVICE_CTRL_ATTACH_RX_DMA</p></td>
<td><p>dma句柄</p></td>
</tr>
<tr class="row-odd"><td><p>DEVICE_CTRL_UART_GET_TX_FIFO</p></td>
<td><p>缓存变量</p></td>
</tr>
<tr class="row-even"><td><p>DEVICE_CTRL_UART_GET_RX_FIFO</p></td>
<td><p>缓存变量</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id17">
<h3><span class="section-number">4.4.5. </span><strong>device_write</strong><a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_write</span></code> 用于串口数据的发送，发送方式根据打开方式可以是轮询、中断、dma。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_write</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pos</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>pos 无作用</p></li>
<li><p>buffer 要写入的 buffer 缓冲区</p></li>
<li><p>size 要写入的长度</p></li>
<li><p>return 错误码，0 表示写入成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="id18">
<h3><span class="section-number">4.4.6. </span><strong>device_read</strong><a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_read</span></code> 用于串口数据的接收，接收方式根据打开方式可以是轮询、中断、dma。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_read</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>pos 无作用</p></li>
<li><p>buffer 要读入的 buffer 缓冲区</p></li>
<li><p>size 要读入的长度</p></li>
<li><p>return 错误码，0 表示读入成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="id19">
<h3><span class="section-number">4.4.7. </span><strong>device_set_callback</strong><a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_set_callback</span></code> 用于注册一个串口中断回调函数。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_set_callback</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">size</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">event</span><span class="p">));</span>
</pre></div>
</div>
<ul>
<li><p>dev 设备句柄</p></li>
<li><p>callback 要注册的中断回调函数</p>
<blockquote>
<div><ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>args 接收发送缓冲区，数据类型为 uint8_t*</p></li>
<li><p>size 传输长度</p></li>
<li><p>event 中断事件类型</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<p>串口设备 <code class="docutils literal notranslate"><span class="pre">event</span></code> 有以下类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">uart_event_type</span>
<span class="p">{</span>
    <span class="n">UART_EVENT_TX_END</span><span class="p">,</span>
    <span class="n">UART_EVENT_TX_FIFO</span><span class="p">,</span>
    <span class="n">UART_EVENT_RX_END</span><span class="p">,</span>
    <span class="n">UART_EVENT_RX_FIFO</span><span class="p">,</span>
    <span class="n">UART_EVENT_RTO</span><span class="p">,</span>
    <span class="n">UART_EVENT_UNKNOWN</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pwm">
<h1><span class="section-number">5. </span>PWM设备<a class="headerlink" href="#pwm" title="永久链接至标题">¶</a></h1>
<div class="section" id="id20">
<h2><span class="section-number">5.1. </span>简介<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h2>
<p>脉冲宽度调制（Pulse width modulation，简称 PWM）是一种用数字方式实现模拟电压控制的技术。它是通过对一系列脉冲的宽度进行调制，等效出所需要的波形（包含形状以及幅值），对模拟信号电平进行数字编码，也就是说通过调节占空比的变化来调节信号、能量等的变化，占空比就是指在一个周期内，信号处于高电平的时间占据整个信号周期的百分比，例如方波的占空比就是50%。博流PWM设备具有以下功能：</p>
<ul class="simple">
<li><p>支持5通道PWM信号生成</p></li>
<li><p>三种时钟源可选择（总线时钟 &lt;bclk&gt;、晶振时钟 &lt;xtal_ck&gt;、慢速时钟 &lt;32k&gt;），搭配 16-bit 时钟分频器</p></li>
<li><p>双门限值域设定，增加脉冲弹性</p></li>
</ul>
</div>
<div class="section" id="id21">
<h2><span class="section-number">5.2. </span>PWM设备接口<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h2>
<p>PWM 设备接口全部遵循标准设备驱动管理层提供的接口。并且为了方便用户调用，将某些标准接口使用宏来重定义。</p>
<div class="section" id="pwm-register">
<h3><span class="section-number">5.2.1. </span><strong>pwm_register</strong><a class="headerlink" href="#pwm-register" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">pwm_register</span></code> 用来注册一个PWM 设备，在注册之前需要打开对应 PWM 通道设备的宏定义,例如 <code class="docutils literal notranslate"><span class="pre">BSP_USING_PWM_CH0</span></code> 方可使用 UART0 设备。注册完成以后才可以使用其他接口，如果没有定义宏，则无法使用 UART 设备。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">pwm_register</span><span class="p">(</span><span class="k">enum</span> <span class="n">pwm_index_type</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">flag</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>index 要注册的设备索引</p></li>
<li><p>name 为注册的设备命名</p></li>
<li><p>flag 默认可读可写属性</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">index</span></code> 用来选择 PWM 设备配置，一个 index 对应一个 PWM 设备的一个通道配置，比如 <code class="docutils literal notranslate"><span class="pre">PWM_CH0_INDEX</span></code> 对应 PWM 通道0 配置，<code class="docutils literal notranslate"><span class="pre">index</span></code> 有如下可选类型</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="n">pwm_index_type</span>
<span class="p">{</span>
<span class="cp">#ifdef BSP_USING_PWM_CH0</span>
    <span class="n">PWM_CH0_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_PWM_CH1</span>
    <span class="n">PWM_CH1_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_PWM_CH2</span>
    <span class="n">PWM_CH2_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_PWM_CH3</span>
    <span class="n">PWM_CH3_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef BSP_USING_PWM_CH4</span>
    <span class="n">PWM_CH4_INDEX</span><span class="p">,</span>
<span class="cp">#endif</span>
    <span class="n">PWM_MAX_INDEX</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h3><span class="section-number">5.2.2. </span><strong>device_open</strong><a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_open</span></code> 用于设备的打开，<code class="docutils literal notranslate"><span class="pre">oflag</span></code> 表示以何种方式打开。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_open</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">oflag</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>oflag 设备的打开方式</p></li>
<li><p>return 错误码，0 表示打开成功，其他表示错误</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">oflag</span></code> 可以写入以下参数：</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEVICE_OFLAG_STREAM_TX  0x001 </span><span class="cm">/* 设备以轮训发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_STREAM_RX  0x002 </span><span class="cm">/* 设备以轮训接收模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_INT_TX     0x004 </span><span class="cm">/* 设备以中断发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_INT_RX     0x008 </span><span class="cm">/* 设备以中断接收模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_DMA_TX     0x010 </span><span class="cm">/* 设备以 DMA 发送模式打开 */</span><span class="cp"></span>
<span class="cp">#define DEVICE_OFLAG_DMA_RX     0x020 </span><span class="cm">/* 设备以 DMA 接收模式打开 */</span><span class="cp"></span>
</pre></div>
</div>
</div>
<div class="section" id="id23">
<h3><span class="section-number">5.2.3. </span><strong>device_close</strong><a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_close</span></code> 用于设备的关闭。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_close</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>return 错误码，0 表示关闭成功，其他表示错误</p></li>
</ul>
</div>
<div class="section" id="id24">
<h3><span class="section-number">5.2.4. </span><strong>device_control</strong><a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">device_control</span></code> 用于根据命令对设备进行控制和参数的修改。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">device_control</span><span class="p">(</span><span class="k">struct</span> <span class="nc">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">args</span><span class="p">);</span>
</pre></div>
</div>
<ul class="simple">
<li><p>dev 设备句柄</p></li>
<li><p>cmd 设备控制命令</p></li>
<li><p>args 控制参数</p></li>
<li><p>return 不同的控制命令返回的意义不同。</p></li>
</ul>
<p>串口设备除了标准的控制命令，还具有自己特殊的控制命令。</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#define DEIVCE_CTRL_PWM_IT_PULSE_COUNT_CONFIG 0x10</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">args</span></code> 根据不同的 <code class="docutils literal notranslate"><span class="pre">cmd</span></code> 传入不同，具体如下：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 71%" />
<col style="width: 29%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>cmd</p></th>
<th class="head"><p>args</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DEVICE_CTRL_SET_INT</p></td>
<td><p>NULL</p></td>
</tr>
<tr class="row-odd"><td><p>DEVICE_CTRL_CLR_INT</p></td>
<td><p>NULL</p></td>
</tr>
<tr class="row-even"><td><p>DEVICE_CTRL_CONFIG</p></td>
<td><p>pwm_config_t</p></td>
</tr>
<tr class="row-odd"><td><p>DEVICE_CTRL_ATTACH_TX_DMA</p></td>
<td><p>dma句柄</p></td>
</tr>
<tr class="row-even"><td><p>DEIVCE_CTRL_PWM_IT_PULSE_COUNT_CONFIG</p></td>
<td><p>周期计数值</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="blink_demo_introduce.html" class="btn btn-neutral float-right" title="1. 流水灯示例" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="connecting_hardware.html" class="btn btn-neutral float-left" title="5. 硬件连接" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2021, BouffaloLab Co., Ltd.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>